<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <title>PHPUnit マニュアル &#8211; 第9章 テストダブル</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="canonical" href="test-doubles.html">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/highlight.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <!--[if lt IE 9]><script src="js/html5shiv.min.js"></script><![endif]-->
 </head>
 <body>
  
  <div class="container-fluid">
   <div class="row">
    <div class="col-md-4 col-lg-3">
     <div class="well well-sm sidebar-nav">
<dl class="toc nav hidden-print"><dt><span class="chapter"><a href="installation.html">1. PHPUnit のインストール</a></span></dt><dd><dl><dt><span class="section"><a href="installation.html#installation.requirements">要件</a></span></dt><dt><span class="section"><a href="installation.html#installation.phar">PHP Archive (PHAR)</a></span></dt><dd><dl><dt><span class="section"><a href="installation.html#installation.phar.windows">Windows</a></span></dt><dt><span class="section"><a href="installation.html#installation.phar.verification">PHPUnit の PHAR リリースの検証</a></span></dt></dl></dd><dt><span class="section"><a href="installation.html#installation.composer">Composer</a></span></dt><dt><span class="section"><a href="installation.html#installation.optional-packages">オプションのパッケージ</a></span></dt></dl></dd><dt><span class="chapter"><a href="writing-tests-for-phpunit.html">2. PHPUnit 用のテストの書き方</a></span></dt><dd><dl><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.test-dependencies">テストの依存性</a></span></dt><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.data-providers">データプロバイダ</a></span></dt><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.exceptions">例外のテスト</a></span></dt><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.errors">PHP のエラーのテスト</a></span></dt><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.output">出力内容のテスト</a></span></dt><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.error-output">エラー出力</a></span></dt><dd><dl><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.error-output.edge-cases">エッジケース</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="textui.html">3. コマンドラインのテストランナー</a></span></dt><dd><dl><dt><span class="section"><a href="textui.html#textui.clioptions">コマンドラインオプション</a></span></dt></dl></dd><dt><span class="chapter"><a href="fixtures.html">4. フィクスチャ</a></span></dt><dd><dl><dt><span class="section"><a href="fixtures.html#fixtures.more-setup-than-teardown">tearDown() よりも setUp()</a></span></dt><dt><span class="section"><a href="fixtures.html#fixtures.variations">バリエーション</a></span></dt><dt><span class="section"><a href="fixtures.html#fixtures.sharing-fixture">フィクスチャの共有</a></span></dt><dt><span class="section"><a href="fixtures.html#fixtures.global-state">グローバルな状態</a></span></dt></dl></dd><dt><span class="chapter"><a href="organizing-tests.html">5. テストの構成</a></span></dt><dd><dl><dt><span class="section"><a href="organizing-tests.html#organizing-tests.filesystem">ファイルシステムを用いたテストスイートの構成</a></span></dt><dt><span class="section"><a href="organizing-tests.html#organizing-tests.xml-configuration">XML 設定ファイルを用いたテストスイートの構成</a></span></dt></dl></dd><dt><span class="chapter"><a href="strict-mode.html">6. リスクを伴うテスト</a></span></dt><dd><dl><dt><span class="section"><a href="strict-mode.html#risky-tests.useless-tests">無意味なテスト</a></span></dt><dt><span class="section"><a href="strict-mode.html#risky-tests.unintentionally-covered-code">意図せぬうちにカバーされているコード</a></span></dt><dt><span class="section"><a href="strict-mode.html#risky-tests.output-during-test-execution">テストの実行時の出力</a></span></dt><dt><span class="section"><a href="strict-mode.html#risky-tests.test-execution-timeout">テストの実行時のタイムアウト</a></span></dt><dt><span class="section"><a href="strict-mode.html#risky-tests.global-state-manipulation">グローバルな状態の変更</a></span></dt></dl></dd><dt><span class="chapter"><a href="incomplete-and-skipped-tests.html">7. 不完全なテスト・テストの省略</a></span></dt><dd><dl><dt><span class="section"><a href="incomplete-and-skipped-tests.html#incomplete-and-skipped-tests.incomplete-tests">不完全なテスト</a></span></dt><dt><span class="section"><a href="incomplete-and-skipped-tests.html#incomplete-and-skipped-tests.skipping-tests">テストの省略</a></span></dt><dt><span class="section"><a href="incomplete-and-skipped-tests.html#incomplete-and-skipped-tests.skipping-tests-using-requires">@requires によるテストのスキップ</a></span></dt></dl></dd><dt><span class="chapter"><a href="database.html">8. データベースのテスト</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.supported-vendors-for-database-testing">データベースのテストに対応しているベンダー</a></span></dt><dt><span class="section"><a href="database.html#database.difficulties-in-database-testing">データベースのテストの難しさ</a></span></dt><dt><span class="section"><a href="database.html#database.the-four-stages-of-a-database-test">データベーステストの四段階</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.clean-up-database">1. データベースのクリーンアップ</a></span></dt><dt><span class="section"><a href="database.html#database.set-up-fixture">2. フィクスチャの準備</a></span></dt><dt><span class="section"><a href="database.html#database.run-test-verify-outcome-and-teardown">3–5. テストの実行、結果の検証、そして後始末</a></span></dt></dl></dd><dt><span class="section"><a href="database.html#database.configuration-of-a-phpunit-database-testcase">PHPUnit のデータベーステストケースの設定</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.implementing-getconnection">getConnection() の実装</a></span></dt><dt><span class="section"><a href="database.html#database.implementing-getdataset">getDataSet() の実装</a></span></dt><dt><span class="section"><a href="database.html#database.what-about-the-database-schema-ddl">データベーススキーマ (DDL) とは?</a></span></dt><dt><span class="section"><a href="database.html#database.tip-use-your-own-abstract-database-testcase">ヒント: 自前でのデータベーステストケースの抽象化</a></span></dt></dl></dd><dt><span class="section"><a href="database.html#database.understanding-datasets-and-datatables">データセットとデータテーブルについて知る</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.available-implementations">利用できる実装</a></span></dt><dt><span class="section"><a href="database.html#database.beware-of-foreign-keys">外部キーには注意</a></span></dt><dt><span class="section"><a href="database.html#database.implementing-your-own-datasetsdatatables">自作のデータセットやデータテーブルの実装</a></span></dt></dl></dd><dt><span class="section"><a href="database.html#database.the-connection-api">接続 API</a></span></dt><dt><span class="section"><a href="database.html#database.database-assertions-api">データベースアサーション API</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.asserting-the-row-count-of-a-table">テーブルの行数のアサーション</a></span></dt><dt><span class="section"><a href="database.html#database.asserting-the-state-of-a-table">テーブルの状態のアサーション</a></span></dt><dt><span class="section"><a href="database.html#database.asserting-the-result-of-a-query">クエリの結果のアサーション</a></span></dt><dt><span class="section"><a href="database.html#database.asserting-the-state-of-multiple-tables">複数のテーブルの状態のアサーション</a></span></dt></dl></dd><dt><span class="section"><a href="database.html#database.frequently-asked-questions">よくある質問</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.will-phpunit-re-create-the-database-schema-for-each-test">PHPUnit は、テストごとにデータベーススキーマを作り直すの?</a></span></dt><dt><span class="section"><a href="database.html#database.am-i-required-to-use-pdo-in-my-application-for-the-database-extension-to-work">PDO を使ったアプリケーションじゃないと Database Extension を使えないの?</a></span></dt><dt><span class="section"><a href="database.html#database.what-can-i-do-when-i-get-a-too-much-connections-error"><span class="quote">「<span class="quote">Too much Connections</span>」</span> というエラーが出たらどうすればいい?</a></span></dt><dt><span class="section"><a href="database.html#database.how-to-handle-null-with-flat-xml-csv-datasets">フラット XML や CSV のデータセットで NULL を扱う方法は?</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="test-doubles.html" class="active">9. テストダブル</a></span></dt><dd><dl><dt><span class="section"><a href="test-doubles.html#test-doubles.stubs">スタブ</a></span></dt><dt><span class="section"><a href="test-doubles.html#test-doubles.mock-objects">モックオブジェクト</a></span></dt><dt><span class="section"><a href="test-doubles.html#test-doubles.prophecy">Prophecy</a></span></dt><dt><span class="section"><a href="test-doubles.html#test-doubles.mocking-traits-and-abstract-classes">トレイトと抽象クラスのモック</a></span></dt><dt><span class="section"><a href="test-doubles.html#test-doubles.stubbing-and-mocking-web-services">ウェブサービスのスタブおよびモック</a></span></dt><dt><span class="section"><a href="test-doubles.html#test-doubles.mocking-the-filesystem">ファイルシステムのモック</a></span></dt></dl></dd><dt><span class="chapter"><a href="testing-practices.html">10. テストの進め方</a></span></dt><dd><dl><dt><span class="section"><a href="testing-practices.html#testing-practices.during-development">開発中のテスト</a></span></dt><dt><span class="section"><a href="testing-practices.html#testing-practices.during-debugging">デバッグ中のテスト</a></span></dt></dl></dd><dt><span class="chapter"><a href="code-coverage-analysis.html">11. コードカバレッジ解析</a></span></dt><dd><dl><dt><span class="section"><a href="code-coverage-analysis.html#code-coverage-analysis.metrics">コードカバレッジの指標</a></span></dt><dt><span class="section"><a href="code-coverage-analysis.html#code-coverage-analysis.whitelisting-files">ファイルのホワイトリスト</a></span></dt><dt><span class="section"><a href="code-coverage-analysis.html#code-coverage-analysis.ignoring-code-blocks">コードブロックの無視</a></span></dt><dt><span class="section"><a href="code-coverage-analysis.html#code-coverage-analysis.specifying-covered-methods">カバーするメソッドの指定</a></span></dt><dt><span class="section"><a href="code-coverage-analysis.html#code-coverage-analysis.edge-cases">エッジケース</a></span></dt></dl></dd><dt><span class="chapter"><a href="other-uses-for-tests.html">12. テストのその他の使用法</a></span></dt><dd><dl><dt><span class="section"><a href="other-uses-for-tests.html#testing-practices.agile-documentation">アジャイルな文書作成</a></span></dt><dt><span class="section"><a href="other-uses-for-tests.html#testing-practices.cross-team-tests">複数チームでのテスト</a></span></dt></dl></dd><dt><span class="chapter"><a href="logging.html">13. ログ出力</a></span></dt><dd><dl><dt><span class="section"><a href="logging.html#logging.xml">テスト結果 (XML)</a></span></dt><dt><span class="section"><a href="logging.html#logging.codecoverage.xml">コードカバレッジ (XML)</a></span></dt><dt><span class="section"><a href="logging.html#logging.codecoverage.text">コードカバレッジ (テキスト)</a></span></dt></dl></dd><dt><span class="chapter"><a href="extending-phpunit.html">14. PHPUnit の拡張</a></span></dt><dd><dl><dt><span class="section"><a href="extending-phpunit.html#extending-phpunit.PHPUnit_Framework_TestCase">PHPUnit\Framework\TestCase のサブクラスの作成</a></span></dt><dt><span class="section"><a href="extending-phpunit.html#extending-phpunit.custom-assertions">カスタムアサーションの作成</a></span></dt><dt><span class="section"><a href="extending-phpunit.html#extending-phpunit.PHPUnit_Framework_TestListener">PHPUnit_Framework_TestListener の実装</a></span></dt><dt><span class="section"><a href="extending-phpunit.html#extending-phpunit.PHPUnit_Extensions_TestDecorator">PHPUnit_Extensions_TestDecorator のサブクラスの作成</a></span></dt><dt><span class="section"><a href="extending-phpunit.html#extending-phpunit.PHPUnit_Framework_Test">PHPUnit_Framework_Test の実装</a></span></dt></dl></dd><dt><span class="appendix"><a href="appendixes.assertions.html">A. アサーション</a></span></dt><dd><dl><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.static-vs-non-static-usage-of-assertion-methods">アサーションメソッドはstaticで使うべきか、それとも非staticで使うべきか</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertArrayHasKey">assertArrayHasKey()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertClassHasAttribute">assertClassHasAttribute()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertArraySubset">assertArraySubset()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertClassHasStaticAttribute">assertClassHasStaticAttribute()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertContains">assertContains()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertContainsOnly">assertContainsOnly()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertContainsOnlyInstancesOf">assertContainsOnlyInstancesOf()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertCount">assertCount()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertDirectoryExists">assertDirectoryExists()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertDirectoryIsReadable">assertDirectoryIsReadable()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertDirectoryIsWritable">assertDirectoryIsWritable()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertEmpty">assertEmpty()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertEqualXMLStructure">assertEqualXMLStructure()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertEquals">assertEquals()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertFalse">assertFalse()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertFileEquals">assertFileEquals()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertFileExists">assertFileExists()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertFileIsReadable">assertFileIsReadable()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertFileIsWritable">assertFileIsWritable()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertGreaterThan">assertGreaterThan()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertGreaterThanOrEqual">assertGreaterThanOrEqual()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertInfinite">assertInfinite()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertInstanceOf">assertInstanceOf()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertInternalType">assertInternalType()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertIsReadable">assertIsReadable()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertIsWritable">assertIsWritable()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertJsonFileEqualsJsonFile">assertJsonFileEqualsJsonFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertJsonStringEqualsJsonFile">assertJsonStringEqualsJsonFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertJsonStringEqualsJsonString">assertJsonStringEqualsJsonString()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertLessThan">assertLessThan()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertLessThanOrEqual">assertLessThanOrEqual()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertNan">assertNan()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertNull">assertNull()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertObjectHasAttribute">assertObjectHasAttribute()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertRegExp">assertRegExp()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertStringMatchesFormat">assertStringMatchesFormat()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertStringMatchesFormatFile">assertStringMatchesFormatFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertSame">assertSame()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertStringEndsWith">assertStringEndsWith()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertStringEqualsFile">assertStringEqualsFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertStringStartsWith">assertStringStartsWith()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertThat">assertThat()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertTrue">assertTrue()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertXmlFileEqualsXmlFile">assertXmlFileEqualsXmlFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertXmlStringEqualsXmlFile">assertXmlStringEqualsXmlFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertXmlStringEqualsXmlString">assertXmlStringEqualsXmlString()</a></span></dt></dl></dd><dt><span class="appendix"><a href="appendixes.annotations.html">B. アノテーション</a></span></dt><dd><dl><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.author">@author</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.after">@after</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.afterClass">@afterClass</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.backupGlobals">@backupGlobals</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.backupStaticAttributes">@backupStaticAttributes</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.before">@before</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.beforeClass">@beforeClass</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.codeCoverageIgnore">@codeCoverageIgnore*</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.covers">@covers</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.coversDefaultClass">@coversDefaultClass</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.coversNothing">@coversNothing</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.dataProvider">@dataProvider</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.depends">@depends</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.expectedException">@expectedException</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.expectedExceptionCode">@expectedExceptionCode</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.expectedExceptionMessage">@expectedExceptionMessage</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.expectedExceptionMessageRegExp">@expectedExceptionMessageRegExp</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.group">@group</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.large">@large</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.medium">@medium</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.preserveGlobalState">@preserveGlobalState</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.requires">@requires</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.runTestsInSeparateProcesses">@runTestsInSeparateProcesses</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.runInSeparateProcess">@runInSeparateProcess</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.small">@small</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.test">@test</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.testdox">@testdox</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.ticket">@ticket</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.uses">@uses</a></span></dt></dl></dd><dt><span class="appendix"><a href="appendixes.configuration.html">C. XML 設定ファイル</a></span></dt><dd><dl><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.phpunit">PHPUnit</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.testsuites">テストスイート</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.groups">グループ</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.whitelisting-files">コードカバレッジ対象のファイルのホワイトリスト</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.logging">ログ出力</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.test-listeners">テストリスナー</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.php-ini-constants-variables">PHP INI 項目や定数、グローバル変数の設定</a></span></dt></dl></dd><dt><span class="appendix"><a href="appendixes.index.html">D. 目次</a></span></dt><dd><dl><dt><span class="index"><a href="appendixes.index.html#appendixes.index.index"></a></span></dt></dl></dd><dt><span class="appendix"><a href="appendixes.bibliography.html">E. 参考文献</a></span></dt><dt><span class="appendix"><a href="appendixes.copyright.html">F. 著作権</a></span></dt></dl>
     </div>
    </div>
    <div class="col-md-8 col-lg-9">
     <div class="row">
      <div class="col-md-1 pull-left prev-nav"><a accesskey="p" href="database.html">戻る</a></div>
      <div class="col-md-1 pull-right next-nav"><a accesskey="n" href="testing-practices.html">次へ</a></div>
     </div>
<div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="test-doubles"></a>第9章 テストダブル</h1></div></div></div><p>
    Gerard Meszaros は、テストダブルの概念を
    <a class="xref" href="appendixes.bibliography.html#Meszaros2007" title="xUnit Test Patterns: Refactoring Test Code">[<abbr class="abbrev">Meszaros2007</abbr>]</a> でこのように述べています。
  </p><div class="blockquote"><table border="0" class="blockquote" style="width: 100%; cellspacing: 0; cellpadding: 0;" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>
      <a id="idp992528" class="indexterm"></a>

      Sometimes it is just plain hard to test the system under test (SUT)
      because it depends on other components that cannot be used in the test
      environment. This could be because they aren't available, they will not
      return the results needed for the test or because executing them would
      have undesirable side effects. In other cases, our test strategy requires
      us to have more control or visibility of the internal behavior of the SUT.
    </p><p>
      - テスト対象のシステム (SUT: system under test)
      をテストすることは、時に非常に困難なこととなります。というのも、
      システムが他のコンポーネントに依存しており、
      そのコンポーネントをテスト環境で利用できないことがあるからです。
      そもそも使用不可能であったりテストで必要な結果を返さなかったり、
      あるいは好ましくない副作用があったりといったことです。
      それ以外の場合も、テスト環境の内部的な振る舞いをきちんと制御して
      目に見えるようにしておくことが必要です。
    </p><p>
      <a id="idp995152" class="indexterm"></a>
      <a id="idp995728" class="indexterm"></a>

      When we are writing a test in which we cannot (or chose not to) use a real
      depended-on component (DOC), we can replace it with a Test Double. The
      Test Double doesn't have to behave exactly like the real DOC; it merely
      has to provide the same API as the real one so that the SUT thinks it is
      the real one!
    </p><p>
      - 実際に依存するコンポーネント (DOC: depended-on component)
      を使わないテストを書く場合は、それをテストダブルで置き換えることができます。
      テストダブルは、必ずしも実際の DOC
      とまったく同様に動作する必要はありません。
      単に実際のものと同じ API を提供し、
      SUT に「これは本物だ!」と思わせるだけでいいのです。
    </p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">Gerard Meszaros</span></td></tr></table></div><p>
    PHPUnit の <code class="literal">createMock($type)</code> メソッドや <code class="literal">getMockBuilder($type)</code> メソッドを使うと、
    指定した元インターフェイス (あるいは元クラス) のテストダブルとして振る舞うオブジェクトを自動的に生成することができます。
    このテストダブルオブジェクトは、元のオブジェクトを要するすべての場面で使うことができます。
  </p><p>
    <code class="literal">createMock($type)</code> メソッドは、指定した型 (インターフェイスやクラス)
    のテストダブルオブジェクトをその場で返します。
    テストダブルの作成は、デフォルトではベストプラクティスに沿って行われます
    (元クラスの <code class="literal">__construct()</code> や <code class="literal">__clone()</code>
    は実行しません)。また、テストダブルのメソッドに渡された引数はクローンされません。
    デフォルトと異なる挙動を求める場合は、
    <code class="literal">getMockBuilder($type)</code> メソッドを用いてテストダブルの生成処理をカスタマイズする必要があります。
  </p><p>
    デフォルトでは、元クラスのすべてのメソッドが置き換えられて、
    (元のメソッドは呼び出さずに) 単に <code class="literal">null</code>
    を返すだけのダミー実装になります。たとえば
    <code class="literal">will($this-&gt;returnValue())</code> メソッドを使うと、
    ダミー実装がコールされたときに値を返すよう設定することができます。
  </p><div class="alert alert-info"><h3 class="title">制限：final、private および static メソッド</h3><p>
      <code class="literal">final</code>, <code class="literal">private</code> および
      <code class="literal">static</code> メソッドのスタブやモックは作れないことに注意しましょう。
      PHPUnit のテストダブル機能ではこれらを無視し、元のメソッドの振る舞いをそのまま維持します。
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.stubs"></a>スタブ</h2></div></div></div><p>
      <a id="idp800128" class="indexterm"></a>

      実際のオブジェクトを置き換えて、
      設定した何らかの値を (オプションで) 返すようなテストダブルのことを
      <span class="emphasis"><em>スタブ</em></span> といいます。
      <span class="emphasis"><em>スタブ</em></span> を使うと、
      「SUT が依存している実際のコンポーネントを置き換え、
      SUT の入力を間接的にコントロールできるようにすることができます。
      これにより、SUT が他の何者も実行しないことを強制させることができます。」
    </p><p>
      <a id="idp802464" class="indexterm"></a>

      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest.php" title="例 9.2: メソッドに固定値を返させるスタブ">例 9.2</a>
      に、スタブメソッドの作成と返り値の設定の方法を示します。まず、
      <code class="literal">PHPUnit\Framework\TestCase</code> クラスの
      <code class="literal">createMock()</code> メソッドを用いて
      <code class="literal">SomeClass</code> オブジェクトのスタブを作成します
      (<a class="xref" href="test-doubles.html#test-doubles.stubs.examples.SomeClass.php" title="例 9.1: スタブを作りたいクラス">例 9.1</a>)。
      次に、PHPUnit が提供する、いわゆる
      <a class="ulink" href="http://martinfowler.com/bliki/FluentInterface.html" target="_top">Fluent Interface</a>
      (<a class="ulink" href="http://capsctrl.que.jp/kdmsnr/wiki/bliki/?FluentInterface" target="_top">流れるようなインターフェイス</a>)
      を用いてスタブの振る舞いを指定します。簡単に言うと、
      いくつもの一時オブジェクトを作成して、
      それらを連結するといった操作は必要ないということです。
      そのかわりに、例にあるようにメソッドの呼び出しを連結します。
      このほうが、より読みやすく "流れるような" コードとなります。
    </p><div class="example"><a id="test-doubles.stubs.examples.SomeClass.php"></a><p class="title"><strong>例 9.1: スタブを作りたいクラス</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class SomeClass
{
    public function doSomething()
    {
        // なにかをします
    }
}
?&gt;</pre></div></div><br class="example-break"></br><div class="example"><a id="test-doubles.stubs.examples.StubTest.php"></a><p class="title"><strong>例 9.2: メソッドに固定値を返させるスタブ</strong></p><div class="example-contents"><a id="idp809936" class="indexterm"></a><a id="idp810512" class="indexterm"></a><a id="idp811088" class="indexterm"></a><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class StubTest extends TestCase
{
    public function testStub()
    {
        // SomeClass クラスのスタブを作成します
        $stub = $this-&gt;createMock(SomeClass::class);

        // スタブの設定を行います
        $stub-&gt;method('doSomething')
             -&gt;willReturn('foo');

        // $stub-&gt;doSomething() をコールすると
        // 'foo' を返すようになります
        $this-&gt;assertEquals('foo', $stub-&gt;doSomething());
    }
}
?&gt;</pre></div></div><br class="example-break"></br><div class="alert alert-info"><h3 class="title">制限："method" という名前のメソッド</h3><p>
        この例がきちんと動作するのは、元のクラスで "method" という名前のメソッドが宣言されていない場合だけです。
      </p><p>
        元のクラスで "method" という名前のメソッドが宣言されている場合は、
        <code class="literal">$stub-&gt;expects($this-&gt;any())-&gt;method('doSomething')-&gt;willReturn('foo');</code> としなければいけません。
      </p></div><p>
      舞台裏では、<code class="literal">createMock()</code> メソッドが使われたときに
      PHPUnit が自動的に、求める振る舞いを実装した新たな PHP のクラスを生成しています。
    </p><p>
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest2.php" title="例 9.3: モックビルダー API を使った、生成されるテストダブルクラスの変更">例 9.3</a> に例を示します。
      これは、モックビルダーの流れるようなインターフェイスを使って、テストダブルの作成方法を設定するものです。
      このテストダブルで使っている設定は、<code class="literal">createMock()</code>
      がデフォルトで使用するベストプラクティスと同じです。
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest2.php"></a><p class="title"><strong>例 9.3: モックビルダー API を使った、生成されるテストダブルクラスの変更</strong></p><div class="example-contents"><a id="idp820336" class="indexterm"></a><a id="idp820912" class="indexterm"></a><a id="idp821488" class="indexterm"></a><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class StubTest extends TestCase
{
    public function testStub()
    {
        // SomeClass クラスのスタブを作成します
        $stub = $this-&gt;getMockBuilder($originalClassName)
                     -&gt;disableOriginalConstructor()
                     -&gt;disableOriginalClone()
                     -&gt;disableArgumentCloning()
                     -&gt;disallowMockingUnknownTypes()
                     -&gt;getMock();

        // スタブの設定を行います
        $stub-&gt;method('doSomething')
             -&gt;willReturn('foo');

        // $stub-&gt;doSomething() をコールすると
        // 'foo' を返すようになります
        $this-&gt;assertEquals('foo', $stub-&gt;doSomething());
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      ここまでの例では、
      <code class="literal">willReturn($value)</code> を使ってシンプルな値を返していました。
      この構文は、
      <code class="literal">will($this-&gt;returnValue($value))</code> と同じ意味です。
      この長い構文での検証を使うと、より複雑な動きをするスタブも作れます。
    </p><p>
      時には、メソッドをコールした際の引数のひとつを
      (そのまま) スタブメソッドコールの返り値としたいこともあるでしょう。
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest3.php" title="例 9.4: メソッドに引数のひとつを返させるスタブ">例 9.4</a> は、
      <code class="literal">returnValue()</code> のかわりに
      <code class="literal">returnArgument()</code> を用いてこれを実現する例です。
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest3.php"></a><p class="title"><strong>例 9.4: メソッドに引数のひとつを返させるスタブ</strong></p><div class="example-contents"><a id="idp828272" class="indexterm"></a><a id="idp828848" class="indexterm"></a><a id="idp829424" class="indexterm"></a><a id="idp830000" class="indexterm"></a><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class StubTest extends TestCase
{
    public function testReturnArgumentStub()
    {
        // SomeClass クラスのスタブを作成します
        $stub = $this-&gt;createMock(SomeClass::class);

        // スタブの設定を行います
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;returnArgument(0));

        // $stub-&gt;doSomething('foo') は 'foo' を返します
        $this-&gt;assertEquals('foo', $stub-&gt;doSomething('foo'));

        // $stub-&gt;doSomething('bar') は 'bar' を返します
        $this-&gt;assertEquals('bar', $stub-&gt;doSomething('bar'));
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      流れるようなインターフェイスをテストするときには、
      スタブメソッドがオブジェクト自身への参照を返すようにできると便利です。
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest4.php" title="例 9.5: スタブオブジェクトへの参照を返すメソッドのスタブ">例 9.5</a> は、
      <code class="literal">returnSelf()</code> を使ってこれを実現する例です。
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest4.php"></a><p class="title"><strong>例 9.5: スタブオブジェクトへの参照を返すメソッドのスタブ</strong></p><div class="example-contents"><a id="idp1210768" class="indexterm"></a><a id="idp1211280" class="indexterm"></a><a id="idp1211792" class="indexterm"></a><a id="idp1212336" class="indexterm"></a><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class StubTest extends TestCase
{
    public function testReturnSelf()
    {
        // SomeClass クラスのスタブを作成します
        $stub = $this-&gt;createMock(SomeClass::class);

        // スタブの設定を行います
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;returnSelf());

        // $stub-&gt;doSomething() は $stub を返します
        $this-&gt;assertSame($stub, $stub-&gt;doSomething());
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      スタブメソッドをコールした結果として、
      定義済みの引数リストにあわせて異なる値を返さなければならないこともあるでしょう。
      <code class="literal">returnValueMap()</code> を使えば、
      マップを作って引数と関連付け、それを返り値に対応させることができます。
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest5.php" title="例 9.6: メソッドにマップからの値を返させるスタブ">例 9.6</a> を参照ください。
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest5.php"></a><p class="title"><strong>例 9.6: メソッドにマップからの値を返させるスタブ</strong></p><div class="example-contents"><a id="idp1216784" class="indexterm"></a><a id="idp1217360" class="indexterm"></a><a id="idp1217936" class="indexterm"></a><a id="idp1218512" class="indexterm"></a><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class StubTest extends TestCase
{
    public function testReturnValueMapStub()
    {
        // SomeClass クラスのスタブを作成します
        $stub = $this-&gt;createMock(SomeClass::class);

        // 値を返すための、引数のマップを作製します
        $map = [
            ['a', 'b', 'c', 'd'],
            ['e', 'f', 'g', 'h']
        ];

        // スタブの設定を行います
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;returnValueMap($map));

        // $stub-&gt;doSomething() は、渡した引数に応じて異なる値を返します
        $this-&gt;assertEquals('d', $stub-&gt;doSomething('a', 'b', 'c'));
        $this-&gt;assertEquals('h', $stub-&gt;doSomething('e', 'f', 'g'));
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      スタブメソッドをコールした結果として固定値
      (<code class="literal">returnValue()</code> を参照ください) や (不変の) 引数
      (<code class="literal">returnArgument()</code> を参照ください)
      ではなく計算した値を返したい場合は、
      <code class="literal">returnCallback()</code> を使用します。
      これは、スタブメソッドからコールバック関数やメソッドの結果を返させます。
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest6.php" title="例 9.7: メソッドにコールバックからの値を返させるスタブ">例 9.7</a>
      を参照ください。
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest6.php"></a><p class="title"><strong>例 9.7: メソッドにコールバックからの値を返させるスタブ</strong></p><div class="example-contents"><a id="idp1224256" class="indexterm"></a><a id="idp1224832" class="indexterm"></a><a id="idp1225408" class="indexterm"></a><a id="idp1225984" class="indexterm"></a><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class StubTest extends TestCase
{
    public function testReturnCallbackStub()
    {
        // SomeClass クラスのスタブを作成します
        $stub = $this-&gt;createMock(SomeClass::class);

        // スタブの設定を行います
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;returnCallback('str_rot13'));

        // $stub-&gt;doSomething($argument) は str_rot13($argument) を返します
        $this-&gt;assertEquals('fbzrguvat', $stub-&gt;doSomething('something'));
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      コールバックメソッドを設定するよりももう少しシンプルな方法として、
      希望する返り値のリストを指定することもできます。この場合に使うのは
      <code class="literal">onConsecutiveCalls()</code> メソッドです。
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest7.php" title="例 9.8: メソッドに、リストで指定した値をその順で返させるスタブ">例 9.8</a>
      の例を参照ください。
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest7.php"></a><p class="title"><strong>例 9.8: メソッドに、リストで指定した値をその順で返させるスタブ</strong></p><div class="example-contents"><a id="idp1230528" class="indexterm"></a><a id="idp1231104" class="indexterm"></a><a id="idp1231680" class="indexterm"></a><a id="idp1232256" class="indexterm"></a><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class StubTest extends TestCase
{
    public function testOnConsecutiveCallsStub()
    {
        // SomeClass クラスのスタブを作成します
        $stub = $this-&gt;createMock(SomeClass::class);

        // スタブの設定を行います
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;onConsecutiveCalls(2, 3, 5, 7));

        // $stub-&gt;doSomething() は毎回異なる値を返します
        $this-&gt;assertEquals(2, $stub-&gt;doSomething());
        $this-&gt;assertEquals(3, $stub-&gt;doSomething());
        $this-&gt;assertEquals(5, $stub-&gt;doSomething());
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      値を返すのではなく、スタブメソッドで例外を発生させることもできます。
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest8.php" title="例 9.9: メソッドに例外をスローさせるスタブ">例 9.9</a>
      に、<code class="literal">throwException()</code> でこれを行う方法を示します。
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest8.php"></a><p class="title"><strong>例 9.9: メソッドに例外をスローさせるスタブ</strong></p><div class="example-contents"><a id="idp1236768" class="indexterm"></a><a id="idp1237344" class="indexterm"></a><a id="idp1237920" class="indexterm"></a><a id="idp1238496" class="indexterm"></a><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class StubTest extends TestCase
{
    public function testThrowExceptionStub()
    {
        // SomeClass クラスのスタブを作成します
        $stub = $this-&gt;createMock(SomeClass::class);

        // スタブの設定を行います
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;throwException(new Exception));

        // $stub-&gt;doSomething() は例外をスローします
        $stub-&gt;doSomething();
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      また、スタブを使用することで、よりよい設計を行うことができるようにもなります。
      あちこちで使用されているリソースを単一の窓口 (façade : ファサード)
      経由でアクセスするようにすることで、
      それを簡単にスタブに置き換えられるようになります。例えば、
      データベースへのアクセスのコードをそこらじゅうにちりばめるのではなく、
      その代わりに <code class="literal">IDatabase</code> インターフェイスを実装した単一の
      <code class="literal">Database</code> オブジェクトを使用するようにします。すると、
      <code class="literal">IDatabase</code> を実装したスタブを作成することで、
      それをテストに使用できるようになるのです。同時に、
      テストを行う際にスタブデータベースを使用するか
      本物のデータベースを使用するかを選択できるようになります。
      つまり開発時にはローカル環境でテストし、
      統合テスト時には実際のデータベースでテストするといったことができるようになるのです。
    </p><p>
      スタブ化しなければならない機能は、たいてい同一オブジェクト内で密結合しています。
      この機能ををひとつの結合したインターフェイスにまとめることで、
      システムのそれ以外の部分との結合を緩やかにすることができます。
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.mock-objects"></a>モックオブジェクト</h2></div></div></div><p>
      実際のオブジェクトを置き換えて、
      (メソッドがコールされたことなどの) 期待する内容を検証するテストダブルのことを
      <span class="emphasis"><em>モック</em></span> といいます。
    </p><p>
      <a id="idp1246848" class="indexterm"></a>

      <span class="emphasis"><em>モックオブジェクト</em></span> は
      "SUT の間接的な出力の内容を検証するために使用する観測地点です。
      一般的に、モックオブジェクトにはテスト用スタブの機能も含まれます。
      まだテストに失敗していない場合に、間接的な出力の検証用の値を SUT に返す機能です。
      したがって、モックオブジェクトとは
      テスト用スタブにアサーション機能を足しただけのものとは異なります。
      それ以外の用途にも使うことができます" (Gerard Meszaros)。
    </p><div class="alert alert-info"><h3 class="title">制限：期待値の自動検証</h3><p>
        そのテストのスコープ内で生成されたモックオブジェクトだけが、PHPUnit による自動検証の対象となります。
        たとえば、データプロバイダなどで生成されたモックオブジェクトや
        <code class="literal">@depends</code> アノテーションで注入されたオブジェクトについては、PHPUnit では検証しません。
      </p></div><p>
      ひとつ例を示します。ここでは、別のオブジェクトを観察している
      あるオブジェクトの特定のメソッド (この例では <code class="literal">update()</code>)
      が正しくコールされたかどうかを調べるものとします。
      <a class="xref" href="test-doubles.html#test-doubles.mock-objects.examples.SUT.php" title="例 9.10: テスト対象のシステム (SUT) の一部である Subject クラスと Observer クラス">例 9.10</a>
      は、テスト対象のシステム (SUT) の一部である
      <code class="literal">Subject</code> クラスと <code class="literal">Observer</code> クラスのコードです。
    </p><div class="example"><a id="test-doubles.mock-objects.examples.SUT.php"></a><p class="title"><strong>例 9.10: テスト対象のシステム (SUT) の一部である Subject クラスと Observer クラス</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class Subject
{
    protected $observers = [];
    protected $name;
    
    public function __construct($name)
    {
        $this-&gt;name = $name;
    }
    
    public function getName()
    {
        return $this-&gt;name;
    }

    public function attach(Observer $observer)
    {
        $this-&gt;observers[] = $observer;
    }

    public function doSomething()
    {
        // なにかをします
        // ...

        // なにかしたということをオブザーバに通知します
        $this-&gt;notify('something');
    }

    public function doSomethingBad()
    {
        foreach ($this-&gt;observers as $observer) {
            $observer-&gt;reportError(42, 'Something bad happened', $this);
        }
    }

    protected function notify($argument)
    {
        foreach ($this-&gt;observers as $observer) {
            $observer-&gt;update($argument);
        }
    }

    // その他のメソッド
}

class Observer
{
    public function update($argument)
    {
        // なにかをします
    }

    public function reportError($errorCode, $errorMessage, Subject $subject)
    {
        // なにかをします
    }

    // その他のメソッド
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      <a id="idp1256704" class="indexterm"></a>

      <a class="xref" href="test-doubles.html#test-doubles.mock-objects.examples.SubjectTest.php" title="例 9.11: あるメソッドが、指定した引数で一度だけコールされることを確かめるテスト">例 9.11</a>
      では、モックオブジェクトを作成して
      <code class="literal">Subject</code> オブジェクトと <code class="literal">Observer</code>
      オブジェクトの対話をテストする方法を説明します。
    </p><p>
      まず
      <code class="literal">PHPUnit\Framework\TestCase</code> クラスの
      <code class="literal">getMockBuilder()</code> メソッドを使用して <code class="literal">Observer</code> のモックオブジェクトを作成します。
      <code class="literal">getMock()</code> メソッドの二番目の (オプションの)
      パラメータに配列を指定しているので、<code class="literal">Observer</code>
      クラスの中の <code class="literal">update()</code> メソッドについてのみモック実装が作成されます。
    </p><p>
      あるメソッドがコールされたのかどうか、そしてどんな引数を渡してコールされたのかを検証したいので、
      <code class="literal">expects()</code> メソッドと <code class="literal">with()</code> メソッドを用意しました。
      これらを使って、このやりとりがどのように行われるのかを指定します。
    </p><div class="example"><a id="test-doubles.mock-objects.examples.SubjectTest.php"></a><p class="title"><strong>例 9.11: あるメソッドが、指定した引数で一度だけコールされることを確かめるテスト</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class SubjectTest extends TestCase
{
    public function testObserversAreUpdated()
    {
        // Observer クラスのモックを作成します。
        // update() メソッドのみのモックです。
        $observer = $this-&gt;getMockBuilder(Observer::class)
                         -&gt;setMethods(['update'])
                         -&gt;getMock();

        // update() メソッドが一度だけコールされ、その際の
        // パラメータは文字列 'something' となる、
        // ということを期待しています。
        $observer-&gt;expects($this-&gt;once())
                 -&gt;method('update')
                 -&gt;with($this-&gt;equalTo('something'));

        // Subject オブジェクトを作成し、Observer オブジェクトの
        // モックをアタッチします。
        $subject = new Subject('My subject');
        $subject-&gt;attach($observer);

        // $subject オブジェクトの doSomething() メソッドをコールします。
        // これは、Observer オブジェクトのモックの update() メソッドを、
        // 文字列 'something' を引数としてコールすることを期待されています。
        $subject-&gt;doSomething();
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      <code class="literal">with()</code> メソッドには任意の数の引数を渡すことができます。
      これは、モック対象のメソッドの引数の数に対応します。
      メソッドの引数に対して、単なるマッチだけでなくより高度な制約を指定することもできます。
    </p><div class="example"><a id="test-doubles.mock-objects.examples.SubjectTest2.php"></a><p class="title"><strong>例 9.12: メソッドが引数つきでコールされることを、さまざまな制約の下でテストする例</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class SubjectTest extends TestCase
{
    public function testErrorReported()
    {
        // Observer クラスのモックを作成します。
        // reportError() メソッドをモックします。
        $observer = $this-&gt;getMockBuilder(Observer::class)
                         -&gt;setMethods(['reportError'])
                         -&gt;getMock();

        $observer-&gt;expects($this-&gt;once())
                 -&gt;method('reportError')
                 -&gt;with(
                       $this-&gt;greaterThan(0),
                       $this-&gt;stringContains('Something'),
                       $this-&gt;anything()
                   );

        $subject = new Subject('My subject');
        $subject-&gt;attach($observer);

        // doSomethingBad() メソッドは、
        // reportError() メソッドを通じてオブザーバにエラーを報告しなければなりません。
        $subject-&gt;doSomethingBad();
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      <code class="literal">withConsecutive()</code> メソッドには、
      テスト対象の呼び出しにあわせて、引数の配列を好きなだけ渡せます。
      個々の配列は制約のリストです。
      <code class="literal">with()</code> と同様に、これがモック対象メソッドのそれぞれの引数に対応します。
    </p><div class="example"><a id="test-doubles.mock-objects.examples.with-consecutive.php"></a><p class="title"><strong>例 9.13: あるメソッドが、指定した引数つきで 2 回呼び出されることを確かめるテスト</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class FooTest extends TestCase
{
    public function testFunctionCalledTwoTimesWithSpecificArguments()
    {
        $mock = $this-&gt;getMockBuilder(stdClass::class)
                     -&gt;setMethods(['set'])
                     -&gt;getMock();

        $mock-&gt;expects($this-&gt;exactly(2))
             -&gt;method('set')
             -&gt;withConsecutive(
                 [$this-&gt;equalTo('foo'), $this-&gt;greaterThan(0)],
                 [$this-&gt;equalTo('bar'), $this-&gt;greaterThan(0)]
             );

        $mock-&gt;set('foo', 21);
        $mock-&gt;set('bar', 48);
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      <code class="literal">callback()</code> 制約を使えば、より複雑な引数の検証ができます。
      この制約は、PHP のコールバックを引数として受け取ります。
      このコールバックは、検証したい引数を受け取って、検証を通過した場合に <code class="literal">true</code>、
      それ以外の場合に <code class="literal">false</code> を返します。
    </p><div class="example"><a id="test-doubles.mock-objects.examples.SubjectTest3.php"></a><p class="title"><strong>例 9.14: より複雑な引数の検証</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class SubjectTest extends TestCase
{
    public function testErrorReported()
    {
        // Observer クラスのモックを作成します。
        // reportError() メソッドをモックします。
        $observer = $this-&gt;getMockBuilder(Observer::class)
                         -&gt;setMethods(['reportError'])
                         -&gt;getMock();

        $observer-&gt;expects($this-&gt;once())
                 -&gt;method('reportError')
                 -&gt;with($this-&gt;greaterThan(0),
                        $this-&gt;stringContains('Something'),
                        $this-&gt;callback(function($subject){
                          return is_callable([$subject, 'getName']) &amp;&amp;
                                 $subject-&gt;getName() == 'My subject';
                        }));

        $subject = new Subject('My subject');
        $subject-&gt;attach($observer);

        // doSomethingBad() メソッドは、
        // reportError() メソッドを通じてオブザーバにエラーを報告しなければなりません。
        $subject-&gt;doSomethingBad();
    }
}
?&gt;</pre></div></div><br class="example-break"></br><div class="example"><a id="test-doubles.mock-objects.examples.clone-object-parameters-usecase.php"></a><p class="title"><strong>例 9.15: メソッドが一度だけ呼ばれ、同じオブジェクトが渡されたことを確かめるテスト</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class FooTest extends TestCase
{
    public function testIdenticalObjectPassed()
    {
        $expectedObject = new stdClass;

        $mock = $this-&gt;getMockBuilder(stdClass::class)
                     -&gt;setMethods(['foo'])
                     -&gt;getMock();

        $mock-&gt;expects($this-&gt;once())
             -&gt;method('foo')
             -&gt;with($this-&gt;identicalTo($expectedObject));

        $mock-&gt;foo($expectedObject);
    }
}
?&gt;</pre></div></div><br class="example-break"></br><div class="example"><a id="test-doubles.mock-objects.examples.enable-clone-object-parameters.php"></a><p class="title"><strong>例 9.16: パラメータのクローンの有効にしたモックオブジェクトの作成</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class FooTest extends TestCase
{
    public function testIdenticalObjectPassed()
    {
        $cloneArguments = true;

        $mock = $this-&gt;getMockBuilder(stdClass::class)
                     -&gt;enableArgumentCloning()
                     -&gt;getMock();

        // これでモックがパラメータをクローンするようになり、
        // identicalTo 制約は失敗します
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      <a class="xref" href="appendixes.assertions.html#appendixes.assertions.assertThat.tables.constraints" title="表A.1 制約">表 A.1</a>
      はメソッドの引数に適用できる制約、そして
      <a class="xref" href="test-doubles.html#test-doubles.mock-objects.tables.matchers" title="表9.1 Matchers">表 9.1</a>
      は起動回数を指定するために使える matcher です。
    </p><div class="table"><a id="test-doubles.mock-objects.tables.matchers"></a><p class="title"><strong>表9.1 Matchers</strong></p><div class="table-contents"><table class="table" summary="Matchers" border="1"><colgroup><col></col><col></col></colgroup><thead><tr><th align="left">Matcher</th><th align="left">意味</th></tr></thead><tbody><tr><td align="left"><code class="literal" style="white-space: normal" id="any">PHPUnit_Framework_MockObject_Matcher_AnyInvokedCount any()</code></td><td align="left">評価対象のメソッドがゼロ回以上実行された際にマッチするオブジェクトを返します。</td></tr><tr><td align="left"><code class="literal" style="white-space: normal" id="never">PHPUnit_Framework_MockObject_Matcher_InvokedCount never()</code></td><td align="left">評価対象のメソッドが実行されなかった際にマッチするオブジェクトを返します。</td></tr><tr><td align="left"><code class="literal" style="white-space: normal" id="atLeastOnce">PHPUnit_Framework_MockObject_Matcher_InvokedAtLeastOnce atLeastOnce()</code></td><td align="left">評価対象のメソッドが最低一回以上実行された際にマッチするオブジェクトを返します。</td></tr><tr><td align="left"><code class="literal" style="white-space: normal" id="once">PHPUnit_Framework_MockObject_Matcher_InvokedCount once()</code></td><td align="left">評価対象のメソッドが一度だけ実行された際にマッチするオブジェクトを返します。</td></tr><tr><td align="left"><code class="literal" style="white-space: normal" id="exactly">PHPUnit_Framework_MockObject_Matcher_InvokedCount exactly(int $count)</code></td><td align="left">評価対象のメソッドが指定した回数だけ実行された際にマッチするオブジェクトを返します。</td></tr><tr><td align="left"><code class="literal" style="white-space: normal" id="at">PHPUnit_Framework_MockObject_Matcher_InvokedAtIndex at(int $index)</code></td><td align="left">評価対象のメソッドが <code class="literal">$index</code> 回目に実行された際にマッチするオブジェクトを返します。</td></tr></tbody></table></div></div><br class="table-break"></br><div class="alert alert-info"><h3 class="title">注記</h3><p>
        <code class="literal">at()</code> マッチャーのパラメータ <code class="literal">$index</code> は、
        指定したモックオブジェクトでの <span class="emphasis"><em>すべてのメソッドの実行</em></span>
        の、ゼロからはじまるインデックスを参照します。
        このマッチャーを使うときには注意しましょう。テストが実装の詳細とあまりにも密結合になり、
        脆いテストになってしまう可能性があるからです。
      </p></div><p>
      <a id="idp1303904" class="indexterm"></a>

      最初に説明したとおり、<code class="literal">createMock()</code>
      メソッドが用いるデフォルトのテストダブル生成方法がニーズを満たさない場合は、
      <code class="literal">getMockBuilder($type)</code> メソッドを使えば生成方法をカスタマイズできます。
      モックビルダーが提供するメソッドの一覧は、次のとおりです。
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">setMethods(array $methods)</code> をモックビルダーオブジェクト上でコールすると、テストダブルで置き換えるメソッドを指定することができます。その他のメソッドの挙動は変更しません。<code class="literal">setMethods(NULL)</code> とすると、どのメソッドも置き換えません。</p></li><li class="listitem"><p><code class="literal">setConstructorArgs(array $args)</code> をコールしてパラメータの配列を渡すと、それを元クラスのコンストラクタに渡すことができます (デフォルトのダミー実装では、コンストラクタは置き換えません)。</p></li><li class="listitem"><p><code class="literal">setMockClassName($name)</code> を使うと、生成されるテストダブルクラスのクラス名を指定することができます。</p></li><li class="listitem"><p><code class="literal">disableOriginalConstructor()</code> を使うと、元クラスのコンストラクタを無効にすることができます。</p></li><li class="listitem"><p><code class="literal">disableOriginalClone()</code> を使うと、元クラスのクローンコンストラクタを無効にすることができます。</p></li><li class="listitem"><p><code class="literal">disableAutoload()</code> を使うと、テストダブルクラスを生成するときに <code class="literal">__autoload()</code> を無効にすることができます。</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.prophecy"></a>Prophecy</h2></div></div></div><p>
      <a class="ulink" href="https://github.com/phpspec/prophecy" target="_top">Prophecy</a> は
      「クセは強いけれども、強力で柔軟な、PHP のオブジェクトモッキングフレームワークです。
      最初は phpspec2 のニーズを満たすために作られましたが、今やそれ以外のテスティングフレームワークでも、
      最小限の努力で使えるようになりました」
      とのことです。
    </p><p>
      PHPUnit は、Prophecy を使ったテストダブルの作成に標準で対応しています。
      <a class="xref" href="test-doubles.html#test-doubles.prophecy.examples.SubjectTest.php" title="例 9.17: あるメソッドが、指定した引数で一度だけコールされることを確かめるテスト">例 9.17</a>
      は、<a class="xref" href="test-doubles.html#test-doubles.mock-objects.examples.SubjectTest.php" title="例 9.11: あるメソッドが、指定した引数で一度だけコールされることを確かめるテスト">例 9.11</a>
      と同じテストを、Prophecy の理念に沿って表すとどうなるかを示す例です。
    </p><div class="example"><a id="test-doubles.prophecy.examples.SubjectTest.php"></a><p class="title"><strong>例 9.17: あるメソッドが、指定した引数で一度だけコールされることを確かめるテスト</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class SubjectTest extends TestCase
{
    public function testObserversAreUpdated()
    {
        $subject = new Subject('My subject');

        // Observer クラスの prophecy を作成します。
        $observer = $this-&gt;prophesize(Observer::class);

        // update() メソッドが一度だけコールされ、その際の
        // パラメータは文字列 'something' となる、
        // ということを期待しています。
        $observer-&gt;update('something')-&gt;shouldBeCalled();

        // prophecy を公開し、モックオブジェクトを
        // Subject にアタッチします。
        $subject-&gt;attach($observer-&gt;reveal());

        // $subject オブジェクトの doSomething() メソッドをコールします。
        // これは、Observer オブジェクトのモックの update() メソッドを、
        // 文字列 'something' を引数としてコールすることを期待されています。
        $subject-&gt;doSomething();
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      Prophecy を使ってスタブやスパイそしてモックを作ったり設定したり使ったりする方法の詳細については、
      その <a class="ulink" href="https://github.com/phpspec/prophecy#how-to-use-it" target="_top">ドキュメント</a> を参照ください。
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.mocking-traits-and-abstract-classes"></a>トレイトと抽象クラスのモック</h2></div></div></div><p>
      <a id="idp1323408" class="indexterm"></a>

      <code class="literal">getMockForTrait()</code> メソッドは、指定したトレイトを使ったモックオブジェクトを返します。
      そのトレイトのすべての抽象メソッドがモックの対象となります。
      これを使えば、トレイトの具象メソッドをテストすることができます。
    </p><div class="example"><a id="test-doubles.mock-objects.examples.TraitClassTest.php"></a><p class="title"><strong>例 9.18: トレイトの具象メソッドのテスト</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

trait AbstractTrait
{
    public function concreteMethod()
    {
        return $this-&gt;abstractMethod();
    }

    public abstract function abstractMethod();
}

class TraitClassTest extends TestCase
{
    public function testConcreteMethod()
    {
        $mock = $this-&gt;getMockForTrait(AbstractTrait::class);

        $mock-&gt;expects($this-&gt;any())
             -&gt;method('abstractMethod')
             -&gt;will($this-&gt;returnValue(true));

        $this-&gt;assertTrue($mock-&gt;concreteMethod());
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      <a id="idp1327376" class="indexterm"></a>

      <code class="literal">getMockForAbstractClass()</code> メソッドは、
      抽象クラスのモックオブジェクトを返します。
      そのクラスのすべての抽象メソッドがモックの対象となります。
      これを使えば、抽象クラスにある具象メソッドをテストすることができます。
    </p><div class="example"><a id="test-doubles.mock-objects.examples.AbstractClassTest.php"></a><p class="title"><strong>例 9.19: 抽象クラスの具象メソッドのテスト</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

abstract class AbstractClass
{
    public function concreteMethod()
    {
        return $this-&gt;abstractMethod();
    }

    public abstract function abstractMethod();
}

class AbstractClassTest extends TestCase
{
    public function testConcreteMethod()
    {
        $stub = $this-&gt;getMockForAbstractClass(AbstractClass::class);

        $stub-&gt;expects($this-&gt;any())
             -&gt;method('abstractMethod')
             -&gt;will($this-&gt;returnValue(true));

        $this-&gt;assertTrue($stub-&gt;concreteMethod());
    }
}
?&gt;</pre></div></div><br class="example-break"></br></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.stubbing-and-mocking-web-services"></a>ウェブサービスのスタブおよびモック</h2></div></div></div><p>
      <a id="idp1332640" class="indexterm"></a>

      ウェブサービスとのやりとりを行うアプリケーションを、
      実際にウェブサービスとやりとりすることなくテストしたくなることもあるでしょう。
      ウェブサービスのスタブやモックを作りやすくするために <code class="literal">getMockFromWsdl()</code>
      メソッドが用意されており、これは <code class="literal">getMock()</code> (上を参照ください)
      とほぼ同様に使うことができます。唯一の違いは、
      <code class="literal">getMockFromWsdl()</code> が返すスタブやモックが WSDL
      のウェブサービス記述にもとづくものであるのに対して <code class="literal">getMock()</code>
      が返すスタブやモックが PHP のクラスやインターフェイスにもとづくものであるという点です。
    </p><p>
      <a class="xref" href="test-doubles.html#test-doubles.stubbing-and-mocking-web-services.examples.GoogleTest.php" title="例 9.20: ウェブサービスのスタブ">例 9.20</a>
      は、<code class="literal">getMockFromWsdl()</code> を使って
      <code class="filename">GoogleSearch.wsdl</code> に記述されたウェブサービスのスタブを作る例です。
    </p><div class="example"><a id="test-doubles.stubbing-and-mocking-web-services.examples.GoogleTest.php"></a><p class="title"><strong>例 9.20: ウェブサービスのスタブ</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class GoogleTest extends TestCase
{
    public function testSearch()
    {
        $googleSearch = $this-&gt;getMockFromWsdl(
          'GoogleSearch.wsdl', 'GoogleSearch'
        );

        $directoryCategory = new stdClass;
        $directoryCategory-&gt;fullViewableName = '';
        $directoryCategory-&gt;specialEncoding = '';

        $element = new stdClass;
        $element-&gt;summary = '';
        $element-&gt;URL = 'https://phpunit.de/';
        $element-&gt;snippet = '...';
        $element-&gt;title = '&lt;b&gt;PHPUnit&lt;/b&gt;';
        $element-&gt;cachedSize = '11k';
        $element-&gt;relatedInformationPresent = true;
        $element-&gt;hostName = 'phpunit.de';
        $element-&gt;directoryCategory = $directoryCategory;
        $element-&gt;directoryTitle = '';

        $result = new stdClass;
        $result-&gt;documentFiltering = false;
        $result-&gt;searchComments = '';
        $result-&gt;estimatedTotalResultsCount = 3.9000;
        $result-&gt;estimateIsExact = false;
        $result-&gt;resultElements = [$element];
        $result-&gt;searchQuery = 'PHPUnit';
        $result-&gt;startIndex = 1;
        $result-&gt;endIndex = 1;
        $result-&gt;searchTips = '';
        $result-&gt;directoryCategories = [];
        $result-&gt;searchTime = 0.248822;

        $googleSearch-&gt;expects($this-&gt;any())
                     -&gt;method('doGoogleSearch')
                     -&gt;will($this-&gt;returnValue($result));

        /**
         * $googleSearch-&gt;doGoogleSearch() はスタブが用意した結果を返し、
         * ウェブサービスの doGoogleSearch() が呼び出されることはありません
         */
        $this-&gt;assertEquals(
          $result,
          $googleSearch-&gt;doGoogleSearch(
            '00000000000000000000000000000000',
            'PHPUnit',
            0,
            1,
            false,
            '',
            false,
            '',
            '',
            ''
          )
        );
    }
}
?&gt;</pre></div></div><br class="example-break"></br></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.mocking-the-filesystem"></a>ファイルシステムのモック</h2></div></div></div><p>
      <a class="ulink" href="https://github.com/mikey179/vfsStream" target="_top">vfsStream</a> は
      <a class="ulink" href="http://ja.wikipedia.org/wiki/仮想ファイルシステム" target="_top">仮想ファイルシステム</a>
      用の <a class="ulink" href="http://www.php.net/streams" target="_top">ストリームラッパー</a> で、
      ユニットテストにおいて実際のファイルシステムのモックを作るときに有用です。
    </p><p>
      <a class="ulink" href="https://getcomposer.org/" target="_top">Composer</a>
      を使ってプロジェクトの依存関係を管理するには、
      <code class="literal">mikey179/vfsStream</code> への依存情報をプロジェクトの
      <code class="filename">composer.json</code> ファイルに追加します。
      次に示すのは最小限の
      <code class="filename">composer.json</code> ファイルの例で、
      開発時の PHPUnit 4.6 と vfsStream への依存を定義しています。
    </p><pre class="programlisting">{
    "require-dev": {
        "phpunit/phpunit": "~4.6",
        "mikey179/vfsStream": "~1"
    }
}</pre><p>
      <a class="xref" href="test-doubles.html#test-doubles.mocking-the-filesystem.examples.Example.php" title="例 9.21: ファイルシステムを操作するクラス">例 9.21</a>
      は、ファイルシステムを操作するクラスの例です。
    </p><div class="example"><a id="test-doubles.mocking-the-filesystem.examples.Example.php"></a><p class="title"><strong>例 9.21: ファイルシステムを操作するクラス</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class Example
{
    protected $id;
    protected $directory;

    public function __construct($id)
    {
        $this-&gt;id = $id;
    }

    public function setDirectory($directory)
    {
        $this-&gt;directory = $directory . DIRECTORY_SEPARATOR . $this-&gt;id;

        if (!file_exists($this-&gt;directory)) {
            mkdir($this-&gt;directory, 0700, true);
        }
    }
}?&gt;</pre></div></div><br class="example-break"></br><p>
      vfsStream のような仮想ファイルシステムがなければ、外部への影響なしに
      <code class="literal">setDirectory()</code> メソッドを個別にテストすることができません
      (<a class="xref" href="test-doubles.html#test-doubles.mocking-the-filesystem.examples.ExampleTest.php" title="例 9.22: ファイルシステムを操作するクラスのテスト">例 9.22</a>
      を参照ください)。
    </p><div class="example"><a id="test-doubles.mocking-the-filesystem.examples.ExampleTest.php"></a><p class="title"><strong>例 9.22: ファイルシステムを操作するクラスのテスト</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class ExampleTest extends TestCase
{
    protected function setUp()
    {
        if (file_exists(dirname(__FILE__) . '/id')) {
            rmdir(dirname(__FILE__) . '/id');
        }
    }

    public function testDirectoryIsCreated()
    {
        $example = new Example('id');
        $this-&gt;assertFalse(file_exists(dirname(__FILE__) . '/id'));

        $example-&gt;setDirectory(dirname(__FILE__));
        $this-&gt;assertTrue(file_exists(dirname(__FILE__) . '/id'));
    }

    protected function tearDown()
    {
        if (file_exists(dirname(__FILE__) . '/id')) {
            rmdir(dirname(__FILE__) . '/id');
        }
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      この方式には、次のような問題があります。
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>外部のリソースを使うため、ファイルシステムのテストが断続的になる可能性があります。その結果、テストがあまり当てにならないものになります。</p></li><li class="listitem"><p><code class="literal">setUp()</code> と <code class="literal">tearDown()</code> で、テストの前後にそのディレクトリがないことを確認する必要があります。</p></li><li class="listitem"><p><code class="literal">tearDown()</code> メソッドを実行する前にテストが異常終了したときに、ファイルシステム上にディレクトリが残ったままとなります。</p></li></ul></div><p>
      <a class="xref" href="test-doubles.html#test-doubles.mocking-the-filesystem.examples.ExampleTest2.php" title="例 9.23: ファイルシステムを操作するクラスのテストにおけるファイルシステムのモックの作成">例 9.23</a>
      は、vfsStream を使ってファイルシステムのモックを作成し、
      ファイルシステムを操作するクラスのテストを行う例です。
    </p><div class="example"><a id="test-doubles.mocking-the-filesystem.examples.ExampleTest2.php"></a><p class="title"><strong>例 9.23: ファイルシステムを操作するクラスのテストにおけるファイルシステムのモックの作成</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
use PHPUnit\Framework\TestCase;

class ExampleTest extends TestCase
{
    public function setUp()
    {
        vfsStreamWrapper::register();
        vfsStreamWrapper::setRoot(new vfsStreamDirectory('exampleDir'));
    }

    public function testDirectoryIsCreated()
    {
        $example = new Example('id');
        $this-&gt;assertFalse(vfsStreamWrapper::getRoot()-&gt;hasChild('id'));

        $example-&gt;setDirectory(vfsStream::url('exampleDir'));
        $this-&gt;assertTrue(vfsStreamWrapper::getRoot()-&gt;hasChild('id'));
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      この方式には次のような利点があります。
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>テストが簡潔になります。</p></li><li class="listitem"><p>vfsStream が、テスト対象のコードから操作するファイルシステム環境を用意してくれるので、開発者はそれを自由に扱えるようになります。</p></li><li class="listitem"><p>実際のファイルシステムを操作することがなくなるので、<code class="literal">tearDown()</code> メソッドでの後始末が不要になります。</p></li></ul></div></div></div>
     <div class="row">
      <div class="col-md-1 pull-left prev-nav"><a accesskey="p" href="database.html">戻る</a></div>
      <div class="col-md-1 pull-right next-nav"><a accesskey="n" href="testing-practices.html">次へ</a></div>
     </div>

   </div>
   <hr/>
   <footer>
    <p><a href="appendixes.copyright.html">Copyright</a> &copy; 2005-2017 <a href="http://sebastian-bergmann.de/">Sebastian Bergmann</a>.</p>
   </footer>
  </div>
  <script src="js/jquery.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/highlight.pack.js"></script>
  <script type="text/javascript">
  $(document).ready(function() { $('pre.programlisting').each(function(i, e) {hljs.highlightBlock(e)}); });
  </script>
 </body>
</html>
