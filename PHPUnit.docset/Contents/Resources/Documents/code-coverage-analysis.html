<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <title>PHPUnit マニュアル &#8211; 第11章 コードカバレッジ解析</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="canonical" href="code-coverage-analysis.html">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/highlight.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700%7CSource+Code+Pro:400,700' rel='stylesheet' type='text/css'>
  <!--[if lt IE 9]><script src="js/html5shiv.min.js"></script><![endif]-->
 </head>
 <body>
  
  <div class="container-fluid">
   <div class="row">
    <div style='padding: 2.0em'>
     <div class="row">
      <div class="col-md-1 pull-left prev-nav"><a accesskey="p" href="testing-practices.html">戻る</a></div>
      <div class="col-md-1 pull-right next-nav"><a accesskey="n" href="other-uses-for-tests.html">次へ</a></div>
     </div>
<div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="code-coverage-analysis"></a>第11章 コードカバレッジ解析</h1></div></div></div><div class="blockquote"><table border="0" class="blockquote" style="width: 100%; cellspacing: 0; cellpadding: 0;" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>
      In computer science, code coverage is a measure used to describe the
      degree to which the source code of a program is tested by a particular
      test suite. A program with high code coverage has been more thoroughly
      tested and has a lower chance of containing software bugs than a program
      with low code coverage.
    </p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">Wikipedia</span></td></tr></table></div><p>
    <a id="idp806256" class="indexterm"></a>
    <a id="idp806800" class="indexterm"></a>

    この章では、PHPUnit のコードカバレッジ機能について学びます。
    これは、テストを実行したときに、実装コードのどの部分が実行されたかを調べるものです。
    PHPUnit のコードカバレッジ解析では
    <a class="ulink" href="https://github.com/sebastianbergmann/php-code-coverage" target="_top">PHP_CodeCoverage</a>
    コンポーネントを使っています。このコンポーネントは、
    <a class="ulink" href="http://www.xdebug.org/" target="_top">Xdebug</a>
    拡張モジュールが提供するステートメントカバレッジ機能を利用しています。
  </p><div class="alert alert-info"><h3 class="title">注記</h3><p>
      Xdebug は PHPUnit 本体には組み込まれていません。
      テストを実行したときに Xdebug がロードできないという notice が出る場合は、
      Xdebug がインストールされていないかあるいはうまく設定できていないのでしょう。
      PHPUnit のコードカバレッジ機能を使う前に、まずは
      <a class="ulink" href="http://xdebug.org/docs/install" target="_top">Xdebug のインストールガイド</a>
      を読んでみましょう。
    </p></div><p>
    PHPUnit は、HTML ベースのコードカバレッジレポートを生成するだけでなく、
    XML ベースのログファイルにコードカバレッジ情報を出力することもできます。
    Clover、Crap4J、PHPUnit など、さまざまな形式に対応しています。
    また、コードカバレッジ情報をテキスト形式で出力 (そして、標準出力に表示)
    したり、PHP のコードとして出力して後処理をしたりすることもできます。
  </p><p>
    コードカバレッジ機能を制御するための
    コマンドラインスイッチの一覧は、<a class="xref" href="textui.html" title="第3章 コマンドラインのテストランナー">第 3 章</a> を参照ください。
    また、設定項目については <a class="xref" href="appendixes.configuration.html#appendixes.configuration.logging" title="ログ出力">「ログ出力」</a> を参照ください。
  </p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="code-coverage-analysis.metrics"></a>コードカバレッジの指標</h2></div></div></div><p>
      コードカバレッジを計測するための指標には、さまざまなものがあります。
    </p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em>Line Coverage</em></span></span></dt><dd><p>
            <span class="emphasis"><em>ラインカバレッジ</em></span> は、
            実行可能な行が実行されたかどうかを計測します。
          </p></dd><dt><span class="term"><span class="emphasis"><em>Function and Method Coverage</em></span></span></dt><dd><p>
            <span class="emphasis"><em>関数・メソッドカバレッジ</em></span> は、
            関数やメソッドが実行されたかどうかを計測します。
            PHP_CodeCoverage は、その関数やメソッド内の実行可能な行がすべて実行された場合にのみ、
            その関数やメソッドが実行されたとみなします。
          </p></dd><dt><span class="term"><span class="emphasis"><em>クラス・トレイトカバレッジ</em></span></span></dt><dd><p>
            <span class="emphasis"><em>クラス・トレイトカバレッジ</em></span> は、
            クラスやトレイトがカバーされたかどうかを計測します。
            PHP_CodeCoverage は、クラスやトレイト内のすべてのメソッドがカバーされている場合にのみ、
            そのクラスやトレイトがカバーされたとみなします。
          </p></dd><dt><span class="term"><span class="emphasis"><em>Opcode Coverage</em></span></span></dt><dd><p>
            <span class="emphasis"><em>オペコードカバレッジ</em></span> は、関数やメソッドのオペコードが、
            テストスイートの実行中に実行されたかどうかを計測します。
            通常は、1 行のコードをコンパイルすると、複数のオペコードになります。
            ラインカバレッジは、複数のオペコードのうち少なくともひとつが実行された時点で、
            その行が実行されたとみなします。
          </p></dd><dt><span class="term"><span class="emphasis"><em>Branch Coverage</em></span></span></dt><dd><p>
            <span class="emphasis"><em>ブランチカバレッジ</em></span> は、テストスイートの実行中に、
            制御構造内の boolean 式が <code class="literal">true</code> あるいは <code class="literal">false</code>
            のどちらかとして評価されたかどうかを計測します。
          </p></dd><dt><span class="term"><span class="emphasis"><em>Path Coverage</em></span></span></dt><dd><p>
            <span class="emphasis"><em>パスカバレッジ</em></span> は、テストスイートの実行中に、
            関数やメソッド内で取りうる実行パスが網羅されたかどうかを計測します。
            実行パスとは、関数やメソッドに入ってから出るまでの間のルート内での分岐のことです。
          </p></dd><dt><span class="term"><span class="emphasis"><em>Change Risk Anti-Patterns (CRAP) Index</em></span></span></dt><dd><p>
            <span class="emphasis"><em>Change Risk Anti-Patterns (CRAP) インデックス</em></span>
            とは、循環的複雑度と、あるコード単位のコードカバレッジに基づいて算出される指標です。
            複雑度が低く、適切なテストカバレッジが達成されているコードは、CRAPインデックスの値が低くなります。
            CRAPインデックスを下げるには、テストを書くか、
            あるいはリファクタリングでコードの複雑性を下げます。
          </p></dd></dl></div><div class="alert alert-info"><h3 class="title">注記</h3><p>
        <span class="emphasis"><em>オペコードカバレッジ</em></span>、
        <span class="emphasis"><em>ブランチカバレッジ</em></span>、
        <span class="emphasis"><em>パスカバレッジ</em></span> については、
        PHP_CodeCoverage ではまだサポートしていません。
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="code-coverage-analysis.whitelisting-files"></a>ファイルのホワイトリスト</h2></div></div></div><p>
      <a id="idp973232" class="indexterm"></a>

      <span class="emphasis"><em>ホワイトリスト</em></span> を設定して、
      PHPUnit に対してどのソースコードファイルをコードカバレッジレポートに含めるかを指定する必要があります。
      ホワイトリストの設定には、コマンドラインオプションの <code class="literal">--whitelist</code>
      を使うか、あるいは設定ファイルを使います (<a class="xref" href="appendixes.configuration.html#appendixes.configuration.whitelisting-files" title="コードカバレッジ対象のファイルのホワイトリスト">「コードカバレッジ対象のファイルのホワイトリスト」</a> を参照ください)。
    </p><p>
      オプションで、ホワイトリストに追加したファイルをすべて、コードカバレッジレポートに追加することもできます。
      そのためには、PHPUnit の設定で <code class="literal">addUncoveredFilesFromWhitelist="true"</code>
      とします (<a class="xref" href="appendixes.configuration.html#appendixes.configuration.whitelisting-files" title="コードカバレッジ対象のファイルのホワイトリスト">「コードカバレッジ対象のファイルのホワイトリスト」</a> を参照ください)。
      こうすれば、まだテストされていないファイルもすべて、レポートに含めることができます。
      カバーされていないファイルにおける、実行可能な行についての情報を知りたい場合は、同じく PHPUnit の設定で
      <code class="literal">processUncoveredFilesFromWhitelist="true"</code> とします
      (<a class="xref" href="appendixes.configuration.html#appendixes.configuration.whitelisting-files" title="コードカバレッジ対象のファイルのホワイトリスト">「コードカバレッジ対象のファイルのホワイトリスト」</a> を参照ください)。
    </p><div class="alert alert-info"><h3 class="title">注記</h3><p>
        <code class="literal">processUncoveredFilesFromWhitelist="true"</code>
        が設定されている場合のソースコードファイルの読み込みでは、
        もしクラスや関数のスコープから外れるコードが含まれていたときに問題が起こる可能性があります。
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="code-coverage-analysis.ignoring-code-blocks"></a>コードブロックの無視</h2></div></div></div><p>
      <a id="idp982176" class="indexterm"></a>
      <a id="idp982752" class="indexterm"></a>
      <a id="idp983328" class="indexterm"></a>
      <a id="idp983920" class="indexterm"></a>

      どうしてもテストができないコードブロックなどを、
      コードカバレッジ解析時に無視させたいこともあるでしょう。
      PHPUnit でこれを実現するには、
      <code class="literal">@codeCoverageIgnore</code>、
      <code class="literal">@codeCoverageIgnoreStart</code> および
      <code class="literal">@codeCoverageIgnoreEnd</code> アノテーションを
      <a class="xref" href="code-coverage-analysis.html#code-coverage-analysis.ignoring-code-blocks.examples.Sample.php" title="例 11.1: @codeCoverageIgnore、@codeCoverageIgnoreStart および @codeCoverageIgnoreEnd アノテーションの使用法">例 11.1</a>
      のように使用します。
    </p><div class="example"><a id="code-coverage-analysis.ignoring-code-blocks.examples.Sample.php"></a><p class="title"><strong>例 11.1: <code class="literal">@codeCoverageIgnore</code>、<code class="literal">@codeCoverageIgnoreStart</code> および <code class="literal">@codeCoverageIgnoreEnd</code> アノテーションの使用法</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
/**
 * @codeCoverageIgnore
 */
class Foo
{
    public function bar()
    {
    }
}

class Bar
{
    /**
     * @codeCoverageIgnore
     */
    public function foo()
    {
    }
}

if (FALSE) {
    // @codeCoverageIgnoreStart
    print '*';
    // @codeCoverageIgnoreEnd
}

exit; // @codeCoverageIgnore
?&gt;</pre></div></div><br class="example-break"></br><p>
      これらのアノテーションを使って無視するよう指定された行は、
      もし実行可能なら (たとえ実行されていなくても) 実行されたものとみなされ、
      強調表示されません。
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="code-coverage-analysis.specifying-covered-methods"></a>カバーするメソッドの指定</h2></div></div></div><p>
      <a id="idp992240" class="indexterm"></a>
      <a id="idp992816" class="indexterm"></a>

      テストコードで <code class="literal">@covers</code> アノテーション
      (<a class="xref" href="appendixes.annotations.html#appendixes.annotations.covers.tables.annotations" title="表B.1 カバーするメソッドを指定するためのアノテーション">表 B.1</a>)
      を参照ください) を使用すると、
      そのテストメソッドがどのメソッドをテストしたいのかを指定することができます。
      これを指定すると、指定したメソッドのコードカバレッジ情報のみを考慮します。
      <a class="xref" href="code-coverage-analysis.html#code-coverage-analysis.specifying-covered-methods.examples.BankAccountTest.php" title="例 11.2: どのメソッドを対象とするかを指定したテスト">例 11.2</a>
      に例を示します。
    </p><div class="example"><a id="code-coverage-analysis.specifying-covered-methods.examples.BankAccountTest.php"></a><p class="title"><strong>例 11.2: どのメソッドを対象とするかを指定したテスト</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class BankAccountTest extends PHPUnit_Framework_TestCase
{
    protected $ba;

    protected function setUp()
    {
        $this-&gt;ba = new BankAccount;
    }

    /**
     * @covers BankAccount::getBalance
     */
    public function testBalanceIsInitiallyZero()
    {
        $this-&gt;assertEquals(0, $this-&gt;ba-&gt;getBalance());
    }

    /**
     * @covers BankAccount::withdrawMoney
     */
    public function testBalanceCannotBecomeNegative()
    {
        try {
            $this-&gt;ba-&gt;withdrawMoney(1);
        }

        catch (BankAccountException $e) {
            $this-&gt;assertEquals(0, $this-&gt;ba-&gt;getBalance());

            return;
        }

        $this-&gt;fail();
    }

    /**
     * @covers BankAccount::depositMoney
     */
    public function testBalanceCannotBecomeNegative2()
    {
        try {
            $this-&gt;ba-&gt;depositMoney(-1);
        }

        catch (BankAccountException $e) {
            $this-&gt;assertEquals(0, $this-&gt;ba-&gt;getBalance());

            return;
        }

        $this-&gt;fail();
    }

    /**
     * @covers BankAccount::getBalance
     * @covers BankAccount::depositMoney
     * @covers BankAccount::withdrawMoney
     */
    public function testDepositWithdrawMoney()
    {
        $this-&gt;assertEquals(0, $this-&gt;ba-&gt;getBalance());
        $this-&gt;ba-&gt;depositMoney(1);
        $this-&gt;assertEquals(1, $this-&gt;ba-&gt;getBalance());
        $this-&gt;ba-&gt;withdrawMoney(1);
        $this-&gt;assertEquals(0, $this-&gt;ba-&gt;getBalance());
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      <a id="idp998848" class="indexterm"></a>
      <a id="idp999424" class="indexterm"></a>

      あるテストが、<span class="emphasis"><em>一切</em></span>メソッドをカバーしてはならないことも指定できます。
      そのために使うのが <code class="literal">@coversNothing</code> アノテーションです。
      (<a class="xref" href="appendixes.annotations.html#appendixes.annotations.coversNothing" title="@coversNothing">「@coversNothing」</a> を参照ください)。
      これは、インテグレーションテストを書く際に
      ユニットテストだけのコードカバレッジを生成させたい場合に便利です。
    </p><div class="example"><a id="code-coverage-analysis.specifying-covered-methods.examples.GuestbookIntegrationTest.php"></a><p class="title"><strong>例 11.3: どのメソッドもカバーすべきでないことを指定したテスト</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class GuestbookIntegrationTest extends PHPUnit_Extensions_Database_TestCase
{
    /**
     * @coversNothing
     */
    public function testAddEntry()
    {
        $guestbook = new Guestbook();
        $guestbook-&gt;addEntry("suzy", "Hello world!");

        $queryTable = $this-&gt;getConnection()-&gt;createQueryTable(
            'guestbook', 'SELECT * FROM guestbook'
        );

        $expectedTable = $this-&gt;createFlatXmlDataSet("expectedBook.xml")
                              -&gt;getTable("guestbook");

        $this-&gt;assertTablesEqual($expectedTable, $queryTable);
    }
}
?&gt;
      </pre></div></div><br class="example-break"></br></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="code-coverage-analysis.edge-cases"></a>エッジケース</h2></div></div></div><p>
      この節では、コードカバレッジ情報がわかりにくくなってしまうような、
      エッジケースについて紹介します。
    </p><div class="example"><a id="code-coverage-analysis.edge-cases.examples.Sample.php"></a><p class="title"><strong>例 11.4: </strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
// カバレッジは「行単位」であって文単位ではないので、
// 一行にまとめられた行はひとつのカバレッジ状態しか持ちません
if (false) this_function_call_shows_up_as_covered();

// コードカバレッジの内部動作上、これら 2 行は特別です。
// 次の行は「実行されていない」となります
if (false)
    // 次の行は「実行されている」となります
    // 実際のところ、ひとつ上の if 文のカバレッジ情報がここに表示されることになるからです!
    will_also_show_up_as_covered();

// これを避けるには、必ず波括弧を使わなければなりません
if (false) {
    this_call_will_never_show_up_as_covered();
}
?&gt;</pre></div></div><br class="example-break"></br></div></div>
     <div class="row">
      <div class="col-md-1 pull-left prev-nav"><a accesskey="p" href="testing-practices.html">戻る</a></div>
      <div class="col-md-1 pull-right next-nav"><a accesskey="n" href="other-uses-for-tests.html">次へ</a></div>
     </div>



    </div>
   </div>
   <hr/>
   <footer>
    <p><a href="appendixes.copyright.html">Copyright</a> &copy; 2005-2016 <a href="http://sebastian-bergmann.de/">Sebastian Bergmann</a>.</p>
   </footer>
  </div>
  <script src="js/jquery.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/highlight.pack.js"></script>
  <script type="text/javascript">
  $(document).ready(function() { $('pre.programlisting').each(function(i, e) {hljs.highlightBlock(e)}); });
  </script>
 </body>
</html>
